import{dirname}from'path';import{fileURLToPath}from'url';import*as _0x4f4f04 from'fs';import*as _0x8f4550 from'path';import*as _0x62489d from'crypto';import{ffmpeg}from'./converter.js';import _0x21ffa5 from'fluent-ffmpeg';import{spawn}from'child_process';import _0x3011d7 from'./uploadFile.js';import _0x4ca0fc from'./uploadImage.js';import{fileTypeFromBuffer}from'file-type';import _0x2aceaf from'node-webpmux';import _0x3f39d7 from'node-fetch';const __dirname=dirname(fileURLToPath(import.meta['url'])),tmp=_0x8f4550['join'](__dirname,'../tmp');function sticker2(_0x596f63,_0x479889){return new Promise(async(_0x8b00de,_0x3c8822)=>{try{if(_0x479889){const _0x326ae0=await _0x3f39d7(_0x479889);if(_0x326ae0['status']!==0xc8)throw await _0x326ae0['text']();_0x596f63=await _0x326ae0['buffer']();}const _0x4c5d3c=_0x8f4550['join'](tmp,+new Date()+'.jpeg');await _0x4f4f04['promises']['writeFile'](_0x4c5d3c,_0x596f63);const _0xb57fad=spawn('ffmpeg',['-y','-i',_0x4c5d3c,'-vf','scale=512:512:flags=lanczos:force_original_aspect_ratio=decrease,format=rgba,pad=512:512:(ow-iw)/2:(oh-ih)/2:color=#00000000,setsar=1','-f','png','-']);_0xb57fad['on']('error',_0x3c8822),_0xb57fad['on']('close',async()=>{await _0x4f4f04['promises']['unlink'](_0x4c5d3c);});const _0x51f3b1=[],[_0x2793bb,..._0x4b10e8]=[...module['exports']['support']['gm']?['gm']:module['exports']['magick']?['magick']:[],'convert','png:-','webp:-'],_0x2a8bce=spawn(_0x2793bb,_0x4b10e8);_0x2a8bce['on']('error',_0x347784=>conn['reply'](m['chat'],util['format'](_0x347784),m)),_0x2a8bce['stdout']['on']('data',_0x31d96c=>_0x51f3b1['push'](_0x31d96c)),_0xb57fad['stdout']['pipe'](_0x2a8bce['stdin']),_0x2a8bce['on']('exit',()=>{_0x8b00de(Buffer['concat'](_0x51f3b1));});}catch(_0x4e4f74){_0x3c8822(_0x4e4f74);}});}async function sticker3(_0x52d399,_0x7afb99,_0x459e72,_0x3ad99c){_0x7afb99=_0x7afb99?_0x7afb99:await _0x3011d7(_0x52d399);const _0x2fb631=await _0x3f39d7('https://api.xteam.xyz/sticker/wm?'+new URLSearchParams(Object['entries']({'url':_0x7afb99,'packname':_0x459e72,'author':_0x3ad99c})));return await _0x2fb631['buffer']();}async function sticker4(_0x3bb035,_0x2819c0){if(_0x2819c0){const _0x47e3f6=await _0x3f39d7(_0x2819c0);if(_0x47e3f6['status']!==0xc8)throw await _0x47e3f6['text']();_0x3bb035=await _0x47e3f6['buffer']();}return await ffmpeg(_0x3bb035,['-vf','scale=512:512:flags=lanczos:force_original_aspect_ratio=decrease,format=rgba,pad=512:512:(ow-iw)/2:(oh-ih)/2:color=#00000000,setsar=1'],'jpeg','webp');}async function sticker5(_0x53ab3f,_0x2b503d,_0x18669,_0x328d58,_0x3c3d82=[''],_0xd658ba={}){const {Sticker:_0xc89388}=await import('wa-sticker-formatter'),_0x16fbf4={'type':'default','pack':_0x18669,'author':_0x328d58,'categories':_0x3c3d82,..._0xd658ba};return new _0xc89388(_0x53ab3f?_0x53ab3f:_0x2b503d,_0x16fbf4)['toBuffer']();}function sticker6(_0x3f11e5,_0x33e28f){return new Promise(async(_0x15f7ca,_0x2e8bc6)=>{if(_0x33e28f){const _0x5287e9=await _0x3f39d7(_0x33e28f);if(_0x5287e9['status']!==0xc8)throw await _0x5287e9['text']();_0x3f11e5=await _0x5287e9['buffer']();}const _0x1ba8ad=await fileTypeFromBuffer(_0x3f11e5)||{'mime':'application/octet-stream','ext':'bin'};if(_0x1ba8ad['ext']=='bin')_0x2e8bc6(_0x3f11e5);const _0xf5ea40=_0x8f4550['join'](__dirname,'../tmp/'+ +new Date()+'.'+_0x1ba8ad['ext']),_0x497e33=_0x8f4550['join'](_0xf5ea40+'.webp');await _0x4f4f04['promises']['writeFile'](_0xf5ea40,_0x3f11e5);const _0x3e337a=/video/i['test'](_0x1ba8ad['mime'])?_0x21ffa5(_0xf5ea40)['inputFormat'](_0x1ba8ad['ext']):_0x21ffa5(_0xf5ea40)['input'](_0xf5ea40);_0x3e337a['on']('error',function(_0x101b90){console['error'](_0x101b90),_0x4f4f04['promises']['unlink'](_0xf5ea40),_0x2e8bc6(_0x3f11e5);})['on']('end',async function(){_0x4f4f04['promises']['unlink'](_0xf5ea40),_0x15f7ca(await _0x4f4f04['promises']['readFile'](_0x497e33));})['addOutputOptions'](['-vcodec','libwebp','-vf','scale=\x27min(320,iw)\x27:min\x27(320,ih)\x27:force_original_aspect_ratio=decrease,fps=15,\x20pad=320:320:-1:-1:color=white@0.0,\x20split\x20[a][b];\x20[a]\x20palettegen=reserve_transparent=on:transparency_color=ffffff\x20[p];\x20[b][p]\x20paletteuse'])['toFormat']('webp')['save'](_0x497e33);});}async function addExif(_0x3a7a80,_0x3cd8a2,_0x252cdd,_0x2fc445=[''],_0x1d102a={}){const _0xc5f9bf=new _0x2aceaf['Image'](),_0x432a22=_0x62489d['randomBytes'](0x20)['toString']('hex'),_0x174722={'sticker-pack-id':_0x432a22,'sticker-pack-name':_0x3cd8a2,'sticker-pack-publisher':_0x252cdd,'emojis':_0x2fc445,..._0x1d102a},_0x84dd16=Buffer['from']([0x49,0x49,0x2a,0x0,0x8,0x0,0x0,0x0,0x1,0x0,0x41,0x57,0x7,0x0,0x0,0x0,0x0,0x0,0x16,0x0,0x0,0x0]),_0x2debc1=Buffer['from'](JSON['stringify'](_0x174722),'utf8'),_0x56e979=Buffer['concat']([_0x84dd16,_0x2debc1]);return _0x56e979['writeUIntLE'](_0x2debc1['length'],0xe,0x4),await _0xc5f9bf['load'](_0x3a7a80),_0xc5f9bf['exif']=_0x56e979,await _0xc5f9bf['save'](null);}async function sticker(_0x3de8bc,_0x664c99,..._0x730425){let _0x748f2a,_0x164084;for(const _0x420106 of[sticker3,global['support']['ffmpeg']&&sticker6,sticker5,global['support']['ffmpeg']&&global['support']['ffmpegWebp']&&sticker4,global['support']['ffmpeg']&&(global['support']['convert']||global['support']['magick']||global['support']['gm'])&&sticker2]['filter'](_0x37d008=>_0x37d008)){try{_0x164084=await _0x420106(_0x3de8bc,_0x664c99,..._0x730425);if(_0x164084['includes']('html'))continue;if(_0x164084['includes']('WEBP'))try{return await addExif(_0x164084,..._0x730425);}catch(_0xe68e50){return console['error'](_0xe68e50),_0x164084;}throw _0x164084['toString']();}catch(_0x34af69){_0x748f2a=_0x34af69;continue;}}return console['error'](_0x748f2a),_0x748f2a;}const support={'ffmpeg':!![],'ffprobe':!![],'ffmpegWebp':!![],'convert':!![],'magick':![],'gm':![],'find':![]};export{sticker,sticker2,sticker3,sticker4,sticker6,addExif,support};